<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TinyLink Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1>TinyLink Dashboard</h1>
  </header>

  <div class="container">

    <!-- Alert Messages -->
    <% if (message) { %>
      <div class="alert <%= alert %>">
        <%= message %>
      </div>
    <% } %>

    <!-- Create Short URL Form -->
    <div class="form-section">
      <form action="/shorten" method="POST" id="linkForm" class="create-form">
        <input 
          type="text" 
          name="originalUrl" 
          placeholder="Enter long URL"
          required
          class="form-input"
        >
        <input 
          type="text" 
          name="customName" 
          placeholder="Custom Code (optional)"
          class="form-input"
        >
        <button type="submit" id="submitBtn" class="submit-btn">Shorten URL</button>
      </form>
    </div>

    <!-- Search/Filter Section -->
    <div class="search-section">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Search by code or URL..."
        class="search-input"
      >
      <button type="button" onclick="filterLinks()" class="search-btn">Search</button>
    </div>

    <!-- Links Table -->
    <% if (!links || links.length === 0) { %>
      <p class="empty">No links created yet...</p>
    <% } else { %>
      <table>
        <thead>
          <tr>
            <th>Short Code</th>
            <th>Target URL</th>
            <th>Clicks</th>
            <th>Last Clicked</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% links.forEach(link => { %>
            <tr>
              <td data-label="Short Code">
                <a href="/<%= link.code %>" target="_blank" class="link-code"><%= link.code %></a>
              </td>
              <td data-label="Target URL" class="truncate" title="<%= link.url %>"><%= link.url %></td>
              <td data-label="Clicks"><%= link.clicks %></td>
              <td data-label="Last Clicked">
                <%= link.last_clicked ? new Date(link.last_clicked).toLocaleString() : 'Never' %>
              </td>
              <td data-label="Actions" class="actions">
                <button type="button" class="copy-btn" onclick="copyURL('<%= link.code %>')">Copy</button>
                <button type="button" class="delete-btn" onclick="showDeleteModal('<%= link.code %>', '<%= link.url %>')">Delete</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>

  <footer>
    &copy; <%= new Date().getFullYear() %> TinyLink
  </footer>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Confirm Delete</h3>
        <button class="modal-close" onclick="cancelDelete()">‚úï</button>
      </div>
      <p>Are you sure you want to delete this short link?</p>
      <div class="modal-details">
        <div><strong>Short Code:</strong> <span id="modalCode"></span></div>
        <div><strong>URL:</strong> <span id="modalUrl"></span></div>
      </div>
      <div class="modal-actions">
        <button onclick="cancelDelete()" class="modal-cancel">Cancel</button>
        <button onclick="proceedDelete()" class="modal-delete">Proceed</button>
      </div>
    </div>
  </div>

  <!-- Running Dinosaur Loader -->
  <div id="dinoLoadingOverlay" class="dino-loading-overlay">
    <div class="dino-game-container">
      <div class="dino-runner">
        <div class="dino-body">
          <div class="dino-head"></div>
          <div class="dino-eye"></div>
          <div class="dino-arm"></div>
          <div class="dino-legs">
            <div class="leg leg-1"></div>
            <div class="leg leg-2"></div>
          </div>
          <div class="dino-tail"></div>
        </div>
      </div>
      <div class="ground-container">
        <div class="ground-line"></div>
        <div class="ground-line"></div>
        <div class="ground-line"></div>
      </div>
    </div>
    <p class="dino-loading-text">Creating your TinyLink... üöÄ</p>
  </div>

  <script>
    // Copy to clipboard
    function copyURL(code) {
      const url = `${window.location.origin}/${code}`;
      navigator.clipboard.writeText(url).then(() => {
        alert("‚úÖ Copied: " + url);
      });
    }

    // Search/filter links
    function filterLinks() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const code = row.querySelector('.link-code').textContent.toLowerCase();
        const url = row.querySelector('.truncate').textContent.toLowerCase();
        row.style.display = (code.includes(input) || url.includes(input)) ? '' : 'none';
      });
    }

    // Show dino loader on form submit
    const form = document.getElementById("linkForm");
    const submitBtn = document.getElementById("submitBtn");
    const dinoOverlay = document.getElementById("dinoLoadingOverlay");

    form.addEventListener("submit", (e) => {
      dinoOverlay.style.display = 'flex';
      submitBtn.disabled = true;
      submitBtn.innerText = "Processing...";
    });

    // Delete Modal Functions
    let deleteCode = null;

    function showDeleteModal(code, url) {
      deleteCode = code;
      document.getElementById('modalCode').textContent = code;
      const truncatedUrl = url.length > 60 ? url.substring(0, 60) + '...' : url;
      document.getElementById('modalUrl').textContent = truncatedUrl;
      document.getElementById('deleteModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function cancelDelete() {
      document.getElementById('deleteModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      deleteCode = null;
    }

    function proceedDelete() {
      if (deleteCode) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${deleteCode}`;
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Close modal on backdrop click
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('deleteModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) cancelDelete();
        });
      }
    });
  </script>
</body>
</html>
